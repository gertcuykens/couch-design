#!/bin/bash
# Copyright(c) gert.cuykens@gmail.com

ADMIN='gert:passwd'
DOMAIN='org.couchdb.user'
SALT=`openssl rand 16 | openssl md5`
SHA1=`echo -n $2$SALT | openssl sha1`
REV=`curl -sIX HEAD http://$ADMIN@localhost:5984/_users/$DOMAIN%3A$1`
#echo ${REV%%$'\n'*}

if [[ $REV =~ Etag:\ \"(.*)\" ]]; then
 curl -X DELETE http://$ADMIN@localhost:5984/_users/$DOMAIN%3A$1?rev=${BASH_REMATCH[1]}
fi

curl -X PUT http://$ADMIN@localhost:5984/_users/$DOMAIN%3A$1 -H 'Content-Type: application/json' -d'{
  "_id"          : "'$DOMAIN:$1'",
  "type"         : "user",
  "name"         : "'$1'",
  "roles"        : [],
  "password_sha" : "'$SHA1'",
  "salt"         : "'$SALT'"
}'

<<TODO
curl -X GET http://$ADMIN@localhost:5984/_session
curl -X DELETE http://$ADMIN@localhost:5984/_session
curl -X PUT http://$ADMIN@localhost:5984/$1/_security -H 'Content-Type: application/json' -d'{
  "admins" : {
     "names" : [],
     "roles" : []
   },
   "readers" : {
     "names" : [],
     "roles" : []
   }
}'
TODO
